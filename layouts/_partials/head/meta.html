{{- /* Overrides FixIt theme partial to improve entry meta descriptions and social previews. */ -}}
{{- $author := partial "function/get-author-map.html" .Params.author -}}

{{- $description := "" -}}
{{- if .Description -}}
  {{- $description = .Description -}}
{{- else if and .IsPage (eq .Section "entries") -}}
  {{- $plain := replaceRE "\r\n" "\n" .Plain -}}
  {{- $lines := split $plain "\n" -}}
  {{- range $lines -}}
    {{- $line := strings.TrimSpace . -}}
    {{- if not $description -}}
      {{- if and $line (not (findRE "^(With|Avec|Mit)\\b" $line)) (not (findRE "(Download PDF|Télécharger le PDF|PDF herunterladen|PDF coming soon|PDF à venir|PDF folgt)" $line)) -}}
        {{- /* Heuristic: lines with many commas are usually the embedded tag list. */ -}}
        {{- if le (len (split $line ",")) 4 -}}
          {{- $description = $line -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- if not $description -}}
    {{- $description = .Summary | plainify -}}
  {{- end -}}
{{- else if and .IsPage .Summary -}}
  {{- $description = .Summary | plainify -}}
{{- else -}}
  {{- $description = .Site.Params.description -}}
{{- end -}}
{{- $description = ($description | plainify | htmlUnescape | truncate 180) -}}

<meta name="author" content="{{ $author.name }}">
<meta name="description" content="{{ $description }}">

{{- $keywords := .Keywords -}}
{{- if not $keywords -}}
  {{- if .IsPage | and .Params.tags -}}
    {{- $keywords = .Params.tags -}}
  {{- else -}}
    {{- $keywords = .Site.Params.keywords -}}
  {{- end -}}
{{- end -}}
{{- with $keywords -}}
  <meta name="keywords" content='{{ delimit . ", " }}'>
{{- end -}}

{{- /* For entries, emit clean social/meta tags (avoid internal templates that inherit noisy summaries). */ -}}
{{- if and .IsPage (eq .Section "entries") -}}
  <meta itemprop="name" content="{{ .Title }}">
  <meta itemprop="description" content="{{ $description }}">
  <meta property="og:site_name" content="{{ .Site.Title }}">
  <meta property="og:title" content="{{ .Title }}">
  <meta property="og:description" content="{{ $description }}">
  <meta property="og:type" content="article">
  <meta property="og:url" content="{{ .Permalink }}">
  {{- with .Site.Params.seo.image -}}
    <meta property="og:image" content="{{ . | absURL }}">
  {{- end -}}
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="{{ .Title }}">
  <meta name="twitter:description" content="{{ $description }}">
  {{- with .Site.Params.seo.image -}}
    <meta name="twitter:image" content="{{ . | absURL }}">
  {{- end -}}
{{- else -}}
  {{- template "_internal/schema.html" . -}}
  {{- template "_internal/opengraph.html" . -}}
  {{- template "_internal/twitter_cards.html" . -}}
{{- end -}}

{{- with .Site.Params.social.Twitter -}}
  <meta name="twitter:creator" content="@{{ . }}" />
{{- end -}}

<meta name="application-name" content="{{ .Site.Params.app.title | default .Site.Title }}">
<meta name="apple-mobile-web-app-title" content="{{ .Site.Params.app.title | default .Site.Title }}">

{{- with .Site.Params.app.themeColor -}}
  {{- $color := . -}}
  {{- if ne (len $color) 2 -}}
    {{- $color = dict "light" . "dark" . -}}
  {{- end -}}
  <meta name="theme-color" data-light="{{ $color.light }}" data-dark="{{ $color.dark }}" content="{{ $color.light }}">
{{- end -}}

{{- with .Site.Params.app.tileColor -}}
  <meta name="msapplication-TileColor" content="{{ . }}">
{{- end -}}

{{- /* Mastodon Validation for the site */ -}}
{{- with .Site.Params.social.Mastodon -}}
  {{- $id := "" -}}
  {{- $prefix := "https://mastodon.social/" -}}
  {{- if reflect.IsMap . -}}
    {{- $id = .Id | default .id -}}
    {{- $prefix = .Prefix | default .prefix | default $prefix -}}
  {{- end -}}
  {{- if $id | and $prefix -}}
    {{- $link := printf "%s/%s" $prefix $id -}}
    {{- $email := printf "%s@%s" (strings.TrimPrefix "@" $id) (urls.Parse $prefix).Host -}}
    <link rel="me" href="{{ $link }}" />
    <meta name="fediverse:creator" content="{{ $email }}" />
  {{- end -}}
{{- end -}}

{{- /* Additional rel=me links for identity/profile verification. */ -}}
{{- with .Site.Params.social.ORCID -}}
  {{- $id := "" -}}
  {{- if reflect.IsMap . -}}
    {{- $id = .id | default .Id -}}
  {{- else -}}
    {{- $id = . -}}
  {{- end -}}
  {{- $id = strings.TrimSpace $id -}}
  {{- if $id -}}
    <link rel="me" href="https://orcid.org/{{ $id }}" />
  {{- end -}}
{{- end -}}
{{- with .Site.Params.social.Scholar.url -}}
  <link rel="me" href="{{ . }}" />
{{- end -}}
{{- with .Site.Params.social.PhilPapers.url -}}
  <link rel="me" href="{{ . }}" />
{{- end -}}
